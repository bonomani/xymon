name: Reference Validation - OpenBSD

on:
  workflow_dispatch:

jobs:
  ref-valid-openbsd:
    name: ${{ matrix.name }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: OpenBSD 7.8 - Server
            openbsd_version: "7.8"
            variant: server
          - name: OpenBSD 7.8 - Client (ct-client)
            openbsd_version: "7.8"
            variant: localclient
          - name: OpenBSD 7.8 - Client (ct-server)
            openbsd_version: "7.8"
            variant: client
          - name: OpenBSD 7.7 - Server
            openbsd_version: "7.7"
            variant: server
          - name: OpenBSD 7.7 - Client (ct-client)
            openbsd_version: "7.7"
            variant: localclient
          - name: OpenBSD 7.7 - Client (ct-server)
            openbsd_version: "7.7"
            variant: client
          - name: OpenBSD 7.6 - Server
            openbsd_version: "7.6"
            variant: server
          - name: OpenBSD 7.6 - Client (ct-client)
            openbsd_version: "7.6"
            variant: localclient
          - name: OpenBSD 7.6 - Client (ct-server)
            openbsd_version: "7.6"
            variant: client
    env:
      VARIANT: ${{ matrix.variant }}
      ENABLE_LDAP: ${{ matrix.variant == 'server' && 'ON' || 'OFF' }}
      ENABLE_SNMP: ${{ matrix.variant == 'server' && 'ON' || 'OFF' }}
      LEGACY_APPLY_OWNERSHIP: ON
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Load legacy hostname (runs for each matrix variant)
        shell: bash
        run: |
          set -euo pipefail
          legacy_cfg="docs/cmake-legacy-migration/refs/make_openbsd/server/var/lib/xymon/server/etc/xymonserver.cfg"
          echo "Legacy hostname: checking ${legacy_cfg}"
          if [ ! -f "${legacy_cfg}" ]; then
            echo "Legacy hostname: skipped (missing ${legacy_cfg})"
            exit 0
          fi
          legacy_host="$(
            tr -d '\r' < "${legacy_cfg}" \
              | awk -F'"' '/^XYMONSERVERHOSTNAME=/{if(!found){print $2; found=1}} END{if(!found) exit 1}'
          )"
          if [ -z "${legacy_host}" ]; then
            legacy_host="$(
              tr -d '\r' < "${legacy_cfg}" \
                | awk '/^XYMONSERVERHOSTNAME=/{sub(/^.*=/,""); sub(/[[:space:]]*#.*/,""); gsub(/^[[:space:]]+|[[:space:]]+$/,""); gsub(/^\"|\"$/,""); if(!found){print; found=1}} END{if(!found) exit 1}'
            )"
          fi
          if [ -z "${legacy_host}" ]; then
            echo "Legacy hostname: skipped (no XYMONSERVERHOSTNAME in ${legacy_cfg})"
            echo "Legacy hostname: first 5 non-comment lines for debug:"
            tr -d '\r' < "${legacy_cfg}" \
              | sed -e '/^[[:space:]]*#/d' -e '/^[[:space:]]*$/d' \
              | head -n5
            exit 0
          fi
          echo "XYMONHOSTNAME=${legacy_host}" >> "$GITHUB_ENV"
          echo "Using legacy hostname: ${legacy_host}"

      - name: Bootstrap install + metadata (CMake)
        uses: cross-platform-actions/action@v0.32.0
        with:
          operating_system: openbsd
          architecture: x86-64
          version: "${{ matrix.openbsd_version }}"
          shell: bash
          memory: 2048M
          cpu_count: 2
          sync_files: true
          run: |
            set -euo pipefail
            variant="${{ matrix.variant }}"
            os_version="${{ matrix.openbsd_version }}"
            ref_prefix="docs/cmake-legacy-migration/refs/make_openbsd/${{ matrix.variant }}"
            legacy_config="${ref_prefix}/meta/config.h"
            refs_root=".ci-artifacts/ref-valid-openbsd/refs"
            artifact_root=".ci-artifacts/ref-valid-openbsd/${os_version}-${variant}"

            mkdir -p "${refs_root}" "${artifact_root}"
            stage_if_present() {
              local src="$1"
              if [ -f "${src}" ]; then
                cp -fp "${src}" "${artifact_root}/$(basename "${src}")"
              fi
            }
            trap '
              stage_if_present /tmp/legacy.config.extract
              stage_if_present /tmp/cmake.config.extract
              stage_if_present /tmp/config.diff
              stage_if_present /tmp/install-cmake-legacy.log
              stage_if_present /tmp/cmake.configure.log
              stage_if_present /tmp/cmake.trace.json
              stage_if_present /tmp/cmake.trace.log
              stage_if_present /tmp/xymon-root-vars.sh
            ' EXIT

            echo "Running bootstrap-install (OpenBSD ${os_version} / ${variant})"
            bash ci/bootstrap-install.sh \
              --os openbsd \
              --version "${os_version}" \
              --variant "${variant}" \
              --build cmake

            if [ ! -f /tmp/xymon-root-vars.sh ]; then
              echo "Staged tree metadata missing" >&2
              exit 1
            fi
            source /tmp/xymon-root-vars.sh
            : "${LEGACY_ROOT:?missing LEGACY_ROOT}"
            : "${LEGACY_TOPDIR:?missing LEGACY_TOPDIR}"

            cmake_config="${XYMON_CONFIG_H:-}"
            if [ -z "${cmake_config}" ] || [ ! -f "${cmake_config}" ]; then
              cmake_config=$(find build-cmake -path '*/include/config.h' | head -n1)
            fi
            if [ -z "${cmake_config}" ] || [ ! -f "${cmake_config}" ]; then
              cmake_config=$(find build-cmake -name config.h | head -n1)
            fi
            if [ -z "${cmake_config}" ] || [ ! -f "${cmake_config}" ]; then
              echo "No CMake-generated config.h found under build-cmake"
              exit 1
            fi
            if [ ! -f "${legacy_config}" ]; then
              echo "Baseline config.h not found at ${legacy_config}"
              exit 1
            fi

            grep -E '^(#define|#undef) (WORDS_|HAVE_|PATH_MAX|XYMON[A-Z_]*DIR)' "${legacy_config}" \
              | grep -v '^#.*HAVE_RPCENT_H' \
              | sort > /tmp/legacy.config.extract
            grep -E '^(#define|#undef) (WORDS_|HAVE_|PATH_MAX|XYMON[A-Z_]*DIR)' "${cmake_config}" \
              | grep -v '^#define XYMON' \
              | sed -E 's/^#define HAVE_BINARY_TREE 0$/#undef HAVE_BINARY_TREE/' \
              | grep -v '^#.*HAVE_RPCENT_H' \
              | sort > /tmp/cmake.config.extract

            diff -u /tmp/legacy.config.extract /tmp/cmake.config.extract || true
            if ! diff -u /tmp/legacy.config.extract /tmp/cmake.config.extract > /tmp/config.diff; then
              echo "config.h parity diff detected:"
              cat /tmp/config.diff
              exit 1
            fi

            bash ci/generate-refs.sh \
              --os openbsd \
              --variant "${variant}" \
              --build cmake \
              --root "${LEGACY_ROOT}" \
              --topdir "${LEGACY_TOPDIR}" \
              --config-h "${XYMON_CONFIG_H:-}" \
              --refs-root "${refs_root}"

      - name: Compare refs snapshot (blocking policy checks)
        shell: bash
        run: |
          set -euo pipefail
          bash ci/compare-refs.sh \
            --baseline-prefix "docs/cmake-legacy-migration/refs/make_openbsd/${{ matrix.variant }}" \
            --candidate-dir ".ci-artifacts/ref-valid-openbsd/refs/cmake.openbsd.${{ matrix.variant }}"

      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ref-valid-${{ matrix.name }}
          if-no-files-found: warn
          path: |
            .ci-artifacts/ref-valid-openbsd/${{ matrix.openbsd_version }}-${{ matrix.variant }}/**
            .ci-artifacts/ref-valid-openbsd/refs/cmake.openbsd.${{ matrix.variant }}/**
            /tmp/legacy.config.extract
            /tmp/cmake.config.extract
            /tmp/config.diff
            /tmp/legacy.list
            /tmp/cmake.list
            /tmp/cmake.filtered.list
            /tmp/allowed-extras.list
            /tmp/legacy-cmake.diff
            /tmp/legacy.keyfiles.missing
            /tmp/legacy.keyfiles.sha256
            /tmp/legacy.keyfiles.perms
            /tmp/legacy.keyfiles.sha256.diff
            /tmp/legacy.symlinks.broken
            /tmp/legacy.symlinks.list
            /tmp/legacy.perms.snapshot
            /tmp/legacy.owners.snapshot
            /tmp/legacy.bin.links
            /tmp/legacy.embedded.paths
            /tmp/legacy.symlinks.diff
            /tmp/legacy.perms.diff
            /tmp/legacy.owners.diff
            /tmp/legacy.owners.names.diff
            /tmp/legacy.binlinks.diff
            /tmp/legacy.needed.norm.diff
            /tmp/legacy.embedded.diff
