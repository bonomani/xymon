name: legacy-reference

on:
  workflow_dispatch:

jobs:
  legacy-reference:
    runs-on: ubuntu-22.04
    container: debian:bookworm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install legacy build dependencies (apt)
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            make \
            gcc \
            git \
            findutils \
            libc-ares-dev \
            libpcre3-dev \
            libldap2-dev \
            librrd-dev \
            libssl-dev \
            libtirpc-dev \
            zlib1g-dev
          useradd -m -s /bin/sh xymon

      - name: Legacy configure
        env:
          ENABLESSL: y
          ENABLELDAP: y
          XYMONUSER: xymon
          HTTPDGID: www-data
        run: |
          ./configure

      - name: Legacy build
        run: |
          make -j2

      - name: Legacy install (staged)
        run: |
          DESTDIR=/tmp/legacy-ref make install

      - name: Generate legacy.ref
        run: |
          root=/tmp/legacy-ref/var/lib/xymon
          if [ ! -d "$root" ]; then
            echo "Missing $root"
            exit 1
          fi
          find "$root" -print \
            | sed 's|^/tmp/legacy-ref||' \
            | sed 's|/var/lib/xymon/$|/var/lib/xymon|' \
            | sort > /tmp/legacy.ref
          cp /tmp/legacy.ref docs/cmake-legacy-migration/legacy.ref

      - name: Generate legacy.keyfiles.sha256
        run: |
          root=/tmp/legacy-ref
          key_files=(
            /var/lib/xymon/server/etc/xymonserver.cfg
            /var/lib/xymon/server/etc/tasks.cfg
            /var/lib/xymon/server/etc/cgioptions.cfg
            /var/lib/xymon/server/etc/graphs.cfg
            /var/lib/xymon/server/etc/client-local.cfg
            /var/lib/xymon/server/etc/columndoc.csv
            /var/lib/xymon/server/etc/protocols.cfg
          )
          : > /tmp/legacy.keyfiles.sha256
          for f in "${key_files[@]}"; do
            p="${root}${f}"
            if [ ! -f "$p" ]; then
              echo "MISSING $f" >> /tmp/legacy.keyfiles.sha256
              continue
            fi
            sha256sum "$p" | sed "s|$p|$f|" >> /tmp/legacy.keyfiles.sha256
          done

      - name: Upload legacy reference
        uses: actions/upload-artifact@v4
        with:
          name: legacy-reference
          path: |
            /tmp/legacy.ref
            /tmp/legacy.keyfiles.sha256
            /tmp/legacy-ref/var/lib/xymon
            docs/cmake-legacy-migration/legacy.ref
