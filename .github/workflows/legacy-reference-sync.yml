name: legacy-reference-sync

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: Branch to pull legacy reference artifacts from
        required: false
        default: main
      target_branch:
        description: Branch to commit updated references into
        required: false
        default: ci/update-legacy-references

permissions:
  contents: write

jobs:
  sync-legacy-references:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download legacy reference artifacts
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p artifacts

          workflows=(
            legacy-reference-linux.yml
            legacy-reference-freebsd.yml
            legacy-reference-openbsd.yml
            legacy-reference-netbsd.yml
          )

          for wf in "${workflows[@]}"; do
            echo "Fetching latest successful run for ${wf} on ${{ inputs.source_branch }}"
            run_id="$(
              gh run list \
                --repo "${GITHUB_REPOSITORY}" \
                --workflow "${wf}" \
                --branch "${{ inputs.source_branch }}" \
                --status success \
                --limit 1 \
                --json databaseId \
                -q '.[0].databaseId'
            )"

            if [ -z "${run_id}" ]; then
              echo "No successful run found for ${wf} on branch ${{ inputs.source_branch }}" >&2
              exit 1
            fi

            out_dir="artifacts/${wf%.yml}"
            mkdir -p "${out_dir}"
            gh run download "${run_id}" --repo "${GITHUB_REPOSITORY}" --dir "${out_dir}"
          done

      - name: Update docs references
        shell: bash
        run: |
          set -euo pipefail
          ref_dir="docs/cmake-legacy-migration"
          mkdir -p "${ref_dir}"

          find artifacts -type f \( -name 'legacy.*.ref' -o -name 'legacy.*.keyfiles.sha256' \) -print0 \
            | while IFS= read -r -d '' f; do
                base="$(basename "$f")"
                install -m 0644 "$f" "${ref_dir}/${base}"
              done

      - name: Commit changes
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No legacy reference changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin "${{ inputs.target_branch }}"
          git checkout -B "${{ inputs.target_branch }}" "origin/${{ inputs.target_branch }}"
          git add docs/cmake-legacy-migration
          git commit -m "Update legacy reference artifacts"
          git push -u origin "${{ inputs.target_branch }}"
