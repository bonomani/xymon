name: legacy-reference-sync

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: Branch to pull legacy reference artifacts from
        required: false
        default: cmake/bootstrap
      target_branch:
        description: Merge-friendly branch to commit updated references into
        required: false
        default: ci/references-update
      archive_branch:
        description: Refs-only archival branch
        required: false
        default: ci/references-update-archive

permissions:
  contents: write

jobs:
  sync-legacy-references:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download legacy reference artifacts
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p artifacts

          workflows=(
            legacy-reference-linux.yml
            legacy-reference-freebsd.yml
            legacy-reference-openbsd.yml
            legacy-reference-netbsd.yml
          )

          for wf in "${workflows[@]}"; do
            echo "Fetching latest successful run for ${wf} on ${{ inputs.source_branch }}"
            run_id="$(
              gh run list \
                --repo "${GITHUB_REPOSITORY}" \
                --workflow "${wf}" \
                --branch "${{ inputs.source_branch }}" \
                --status success \
                --limit 1 \
                --json databaseId \
                -q '.[0].databaseId'
            )"

            if [ -z "${run_id}" ]; then
              echo "No successful run found for ${wf} on branch ${{ inputs.source_branch }}" >&2
              exit 1
            fi

            out_dir="artifacts/${wf%.yml}"
            mkdir -p "${out_dir}"
            gh run download "${run_id}" --repo "${GITHUB_REPOSITORY}" --dir "${out_dir}"
          done

      - name: Sync archive branch
        shell: bash
        run: |
          set -euo pipefail
          ref_dir="docs/cmake-legacy-migration"
          archive_branch="${{ inputs.archive_branch }}"

          if git fetch origin "${archive_branch}"; then
            git checkout -B "${archive_branch}" "origin/${archive_branch}"
          else
            git checkout --orphan "${archive_branch}"
            git rm -rf . >/dev/null 2>&1 || true
          fi

          git clean -fd
          mkdir -p "${ref_dir}"
          find "${ref_dir}" -type f \( -name 'legacy.*.ref' -o -name 'legacy.*.keyfiles.sha256' -o -name 'legacy.*.symlinks' -o -name 'legacy.*.perms' -o -name 'legacy.*.binlinks' -o -name 'legacy.*.embedded.paths' \) -delete

          find artifacts -type f \( -name 'legacy.*.ref' -o -name 'legacy.*.keyfiles.sha256' -o -name 'legacy.*.symlinks' -o -name 'legacy.*.perms' -o -name 'legacy.*.binlinks' -o -name 'legacy.*.embedded.paths' \) -print0 \
            | while IFS= read -r -d '' f; do
                base="$(basename "$f")"
                install -m 0644 "$f" "${ref_dir}/${base}"
              done

          if git diff --quiet; then
            echo "No legacy reference changes to commit on archive branch."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "${ref_dir}"
            git commit -m "Update legacy reference artifacts"
            git push -u origin "${archive_branch}"
          fi

      - name: Sync merge-friendly branch
        shell: bash
        run: |
          set -euo pipefail
          ref_dir="docs/cmake-legacy-migration"
          source_branch="${{ inputs.source_branch }}"
          target_branch="${{ inputs.target_branch }}"

          git fetch origin "${source_branch}"
          if git fetch origin "${target_branch}"; then
            if ! git merge-base --is-ancestor "origin/${source_branch}" "origin/${target_branch}"; then
              echo "Target branch is not based on ${source_branch}; recreating ${target_branch}."
              git push origin --delete "${target_branch}" || true
              git checkout -B "${target_branch}" "origin/${source_branch}"
            else
              git checkout -B "${target_branch}" "origin/${target_branch}"
            fi
          else
            git checkout -B "${target_branch}" "origin/${source_branch}"
          fi

          git clean -fd "${ref_dir}"
          git checkout -- "${ref_dir}" || true
          mkdir -p "${ref_dir}"
          find "${ref_dir}" -type f \( -name 'legacy.*.ref' -o -name 'legacy.*.keyfiles.sha256' -o -name 'legacy.*.symlinks' -o -name 'legacy.*.perms' -o -name 'legacy.*.binlinks' -o -name 'legacy.*.embedded.paths' \) -delete

          find artifacts -type f \( -name 'legacy.*.ref' -o -name 'legacy.*.keyfiles.sha256' -o -name 'legacy.*.symlinks' -o -name 'legacy.*.perms' -o -name 'legacy.*.binlinks' -o -name 'legacy.*.embedded.paths' \) -print0 \
            | while IFS= read -r -d '' f; do
                base="$(basename "$f")"
                install -m 0644 "$f" "${ref_dir}/${base}"
              done

          if git diff --quiet; then
            echo "No legacy reference changes to commit on merge-friendly branch."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${ref_dir}"
          git commit -m "Update legacy reference artifacts"
          git push -u origin "${target_branch}"
