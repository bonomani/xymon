name: legacy-validate-extended

on:
  workflow_dispatch:

jobs:
  legacy-validate-extended:
    runs-on: ${{ matrix.runs_on }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-22.04
            runs_on: ubuntu-22.04
            dep_family: gh-debian
            dep_os: ubuntu
            dep_version: latest
          - name: ubuntu-24.04
            runs_on: ubuntu-24.04
            dep_family: gh-debian
            dep_os: ubuntu
            dep_version: latest
          - name: debian-bookworm
            runs_on: ubuntu-22.04
            container: debian:bookworm
            pkg_mgr: apt
            dep_family: debian
            dep_os: debian
            dep_version: bookworm
          - name: debian-bullseye
            runs_on: ubuntu-22.04
            container: debian:bullseye
            pkg_mgr: apt
            dep_family: debian
            dep_os: debian
            dep_version: bullseye
          - name: rockylinux-9
            runs_on: ubuntu-22.04
            container: rockylinux:9
            pkg_mgr: dnf
            dep_family: rpm
            dep_os: rockylinux
            dep_version: 9
          - name: almalinux-9
            runs_on: ubuntu-22.04
            container: almalinux:9
            pkg_mgr: dnf
            dep_family: rpm
            dep_os: almalinux
            dep_version: 9
          - name: centos-7
            runs_on: ubuntu-22.04
            container: centos:7
            pkg_mgr: yum
            cmake_bin: cmake3
            dep_family: rpm
            dep_os: centos
            dep_version: 7
          - name: fedora-40
            runs_on: ubuntu-22.04
            container: fedora:40
            pkg_mgr: dnf
            dep_family: rpm
            dep_os: fedora
            dep_version: 40
          - name: opensuse-leap-15.6
            runs_on: ubuntu-22.04
            container: opensuse/leap:15.6
            pkg_mgr: zypper
            dep_family: suse
            dep_os: opensuse_leap
            dep_version: 15_6
          - name: alpine-3
            runs_on: ubuntu-22.04
            container: alpine:3.19
            pkg_mgr: apk
            dep_family: alpine
            dep_os: alpine
            dep_version: 3
          - name: archlinux
            runs_on: ubuntu-22.04
            container: archlinux:latest
            pkg_mgr: pacman
            dep_family: arch
            dep_os: archlinux
            dep_version: latest

    name: ${{ matrix.name }}
    env:
      CMAKE_BIN: ${{ matrix.cmake_bin }}
      VARIANT: server
      ENABLE_LDAP: ON
      ENABLE_SNMP: ON

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies (Linux)
        if: ${{ matrix.dep_family != 'bsd' }}
        shell: bash
        run: |
          bash ci/deps/install-default-packages.sh \
            --family "${{ matrix.dep_family }}" \
            --os "${{ matrix.dep_os }}" \
            --version "${{ matrix.dep_version }}"

      - name: Install build dependencies (BSD)
        if: ${{ matrix.dep_family == 'bsd' }}
        shell: bash
        run: |
          bash ci/deps/install-bsd-packages.sh \
            --os "${{ matrix.dep_os }}" \
            --version "${{ matrix.dep_version }}"

      - name: Load legacy hostname (server only)
        shell: bash
        run: |
          set -euo pipefail
          legacy_cfg="docs/cmake-legacy-migration/refs/make_linux/server/var/lib/xymon/server/etc/xymonserver.cfg"
          echo "Legacy hostname: checking ${legacy_cfg}"
          if [ ! -f "${legacy_cfg}" ]; then
            echo "Legacy hostname: skipped (missing ${legacy_cfg})"
            exit 0
          fi
          legacy_host="$(
            tr -d '\r' < "${legacy_cfg}" \
              | awk -F'"' '/^XYMONSERVERHOSTNAME=/{if(!found){print $2; found=1}} END{if(!found) exit 1}'
          )"
          if [ -z "${legacy_host}" ]; then
            legacy_host="$(
              tr -d '\r' < "${legacy_cfg}" \
                | awk '/^XYMONSERVERHOSTNAME=/{sub(/^.*=/,""); sub(/[[:space:]]*#.*/,""); gsub(/^[[:space:]]+|[[:space:]]+$/,""); gsub(/^\"|\"$/,""); if(!found){print; found=1}} END{if(!found) exit 1}'
            )"
          fi
          if [ -z "${legacy_host}" ]; then
            echo "Legacy hostname: skipped (no XYMONSERVERHOSTNAME in ${legacy_cfg})"
            echo "Legacy hostname: first 5 non-comment lines for debug:"
            tr -d '\r' < "${legacy_cfg}" \
              | sed -e '/^[[:space:]]*#/d' -e '/^[[:space:]]*$/d' \
              | head -n5
            exit 0
          fi
          echo "XYMONHOSTNAME=${legacy_host}" >> "$GITHUB_ENV"
          echo "Using legacy hostname: ${legacy_host}"

      - name: Configure (legacy)
        shell: bash
        run: |
          set -x
          set -o pipefail
          extra_args=()
          if [ -n "${XYMONHOSTNAME:-}" ]; then
            extra_args+=("-DXYMONHOSTNAME=${XYMONHOSTNAME}")
          fi
          ${CMAKE_BIN:-cmake} -S . -B build-cmake \
            -G Ninja \
            -DUSE_GNUINSTALLDIRS=OFF \
            -DCMAKE_INSTALL_PREFIX=/ \
            -DLEGACY_APPLY_OWNERSHIP=OFF \
            -DLEGACY_DESTDIR=/tmp/cmake-ref-root \
            -DXYMON_VARIANT=all \
            "${extra_args[@]}" 2>&1 | tee /tmp/cmake.configure.log

      - name: Trace CMake configure (debug)
        if: ${{ matrix.name == 'debian-bookworm' }}
        shell: bash
        run: |
          set -o pipefail
          extra_args=()
          if [ -n "${XYMONHOSTNAME:-}" ]; then
            extra_args+=("-DXYMONHOSTNAME=${XYMONHOSTNAME}")
          fi
          ${CMAKE_BIN:-cmake} -S . -B build-cmake-trace \
            -G Ninja \
            -DUSE_GNUINSTALLDIRS=OFF \
            -DCMAKE_INSTALL_PREFIX=/ \
            -DLEGACY_APPLY_OWNERSHIP=OFF \
            -DLEGACY_DESTDIR=/tmp/cmake-ref-root \
            -DXYMON_VARIANT=all \
            "${extra_args[@]}" \
            --trace-expand \
            --trace-format=json-v1 \
            --trace-redirect=/tmp/cmake.trace.json 2>&1 | tee /tmp/cmake.trace.log

      - name: Build
        run: |
          ${CMAKE_BIN:-cmake} --build build-cmake -j2

      - name: Capture CMake configure logs
        if: always()
        run: |
          if [ -f /tmp/cmake.configure.log ]; then
            echo "=== cmake.configure.log (cmake -E search) ==="
            grep -n "cmake -E" /tmp/cmake.configure.log || true
          fi
          if [ -f /tmp/cmake.trace.json ]; then
            echo "=== cmake.trace.json (cmake -E search) ==="
            rg -n --fixed-strings -- '"cmake","-E"' /tmp/cmake.trace.json || true
          fi
          if [ -f /tmp/cmake.trace.log ]; then
            echo "=== cmake.trace.log (cmake -E search) ==="
            rg -n --fixed-strings -- "cmake -E" /tmp/cmake.trace.log || true
          fi
          if [ -f build-cmake/CMakeFiles/CMakeError.log ]; then
            echo "=== CMakeError.log ==="
            cat build-cmake/CMakeFiles/CMakeError.log
          fi
          if [ -f build-cmake/CMakeFiles/CMakeOutput.log ]; then
            echo "=== CMakeOutput.log ==="
            cat build-cmake/CMakeFiles/CMakeOutput.log
          fi

      - name: Validate config.h parity
        run: |
          legacy_config="docs/cmake-legacy-migration/refs/make_linux/server/meta/config.h"
          cmake_config=$(find build-cmake -name config.h | head -n1)
          if [ -z "$cmake_config" ]; then
            echo "No CMake-generated config.h found under build-cmake"
            exit 1
          fi
          if [ ! -f "$legacy_config" ]; then
            echo "Baseline config.h not found at $legacy_config"
            exit 1
          fi

          grep -E '^(#define|#undef) (WORDS_|HAVE_|PATH_MAX|XYMON[A-Z_]*DIR)' "$legacy_config" \
            | sort > /tmp/legacy.config.extract
          grep -E '^(#define|#undef) (WORDS_|HAVE_|PATH_MAX|XYMON[A-Z_]*DIR)' "$cmake_config" \
            | sort > /tmp/cmake.config.extract

          diff -u /tmp/legacy.config.extract /tmp/cmake.config.extract || true
          if ! diff -u /tmp/legacy.config.extract /tmp/cmake.config.extract > /tmp/config.diff; then
            echo "config.h parity diff detected:"
            cat /tmp/config.diff
            exit 1
          fi

      - name: Install legacy targets (staging)
        shell: bash
        run: |
          set -o pipefail
          ${CMAKE_BIN:-cmake} --build build-cmake --target web_cgi_links docs
          LEGACY_DESTDIR=/tmp/cmake-ref-root \
          ${CMAKE_BIN:-cmake} --build build-cmake --target install-legacy-dirs install-legacy-files 2>&1 | tee /tmp/install-cmake-legacy.log

      - name: Generate CMake refs snapshot
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/xymon-refs
          bash ci/generate-refs.sh \
            --os linux \
            --variant server \
            --build cmake \
            --root /tmp/cmake-ref-root/var/lib/xymon \
            --topdir /var/lib/xymon \
            --refs-root /tmp/xymon-refs

      - name: Compare refs snapshot (non-blocking)
        shell: bash
        run: |
          set -euo pipefail
          bash ci/compare-refs.sh \
            --baseline-prefix "docs/cmake-legacy-migration/refs/make_linux/server" \
            --candidate-dir "/tmp/xymon-refs/cmake.linux.server" \
            --candidate-root "/tmp/cmake-ref-root/var/lib/xymon"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: legacy-validate-extended-${{ matrix.name }}
          path: |
            /tmp/legacy.config.extract
            /tmp/cmake.config.extract
            /tmp/config.diff
            /tmp/legacy.list
            /tmp/cmake.list
            /tmp/cmake.filtered.list
            /tmp/allowed-extras.list
            /tmp/legacy-cmake.diff
            /tmp/legacy.keyfiles.missing
            /tmp/legacy.keyfiles.sha256
            /tmp/legacy.keyfiles.perms
            /tmp/legacy.keyfiles.sha256.diff
            /tmp/legacy.symlinks.broken
            /tmp/legacy.symlinks.list
            /tmp/legacy.perms.snapshot
            /tmp/legacy.bin.links
            /tmp/legacy.embedded.paths
            /tmp/legacy.symlinks.diff
            /tmp/legacy.perms.diff
            /tmp/legacy.binlinks.diff
            /tmp/legacy.embedded.diff
            /tmp/install-cmake-legacy.log
            /tmp/cmake.configure.log
            /tmp/cmake.trace.json
            /tmp/cmake.trace.log
