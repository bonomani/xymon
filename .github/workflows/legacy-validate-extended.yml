name: legacy-validate-extended

on:
  workflow_dispatch:

jobs:
  legacy-validate-extended:
    runs-on: ${{ matrix.runs_on }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-22.04
            runs_on: ubuntu-22.04
            dep_family: gh-debian
            dep_os: ubuntu
            dep_version: latest
          - name: ubuntu-24.04
            runs_on: ubuntu-24.04
            dep_family: gh-debian
            dep_os: ubuntu
            dep_version: latest
          - name: debian-bookworm
            runs_on: ubuntu-22.04
            container: debian:bookworm
            pkg_mgr: apt
            dep_family: debian
            dep_os: debian
            dep_version: bookworm
          - name: debian-bullseye
            runs_on: ubuntu-22.04
            container: debian:bullseye
            pkg_mgr: apt
            dep_family: debian
            dep_os: debian
            dep_version: bullseye
          - name: rockylinux-9
            runs_on: ubuntu-22.04
            container: rockylinux:9
            pkg_mgr: dnf
            dep_family: rpm
            dep_os: rockylinux
            dep_version: 9
          - name: almalinux-9
            runs_on: ubuntu-22.04
            container: almalinux:9
            pkg_mgr: dnf
            dep_family: rpm
            dep_os: almalinux
            dep_version: 9
          - name: centos-7
            runs_on: ubuntu-22.04
            container: centos:7
            pkg_mgr: yum
            cmake_bin: cmake3
            dep_family: rpm
            dep_os: centos
            dep_version: 7
          - name: fedora-40
            runs_on: ubuntu-22.04
            container: fedora:40
            pkg_mgr: dnf
            dep_family: rpm
            dep_os: fedora
            dep_version: 40
          - name: opensuse-leap-15.6
            runs_on: ubuntu-22.04
            container: opensuse/leap:15.6
            pkg_mgr: zypper
            dep_family: suse
            dep_os: opensuse_leap
            dep_version: 15_6
          - name: alpine-3
            runs_on: ubuntu-22.04
            container: alpine:3.19
            pkg_mgr: apk
            dep_family: alpine
            dep_os: alpine
            dep_version: 3
          - name: archlinux
            runs_on: ubuntu-22.04
            container: archlinux:latest
            pkg_mgr: pacman
            dep_family: arch
            dep_os: archlinux
            dep_version: latest

    name: ${{ matrix.name }}
    env:
      CMAKE_BIN: ${{ matrix.cmake_bin }}
      VARIANT: server
      ENABLE_LDAP: ON
      ENABLE_SNMP: ON

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies (apt)
        if: ${{ (matrix.pkg_mgr == '' || matrix.pkg_mgr == 'apt') }}
        run: |
          bash ci/deps/install-apt-packages.sh \
            --family "${{ matrix.dep_family }}" \
            --os "${{ matrix.dep_os }}" \
            --version "${{ matrix.dep_version }}"

      - name: Install build dependencies (dnf)
        if: ${{ matrix.pkg_mgr == 'dnf' }}
        run: |
          bash ci/deps/install-dnf-packages.sh \
            --family "${{ matrix.dep_family }}" \
            --os "${{ matrix.dep_os }}" \
            --version "${{ matrix.dep_version }}"

      - name: Install build dependencies (yum)
        if: ${{ matrix.pkg_mgr == 'yum' }}
        run: |
          bash ci/deps/install-yum-packages.sh \
            --family "${{ matrix.dep_family }}" \
            --os "${{ matrix.dep_os }}" \
            --version "${{ matrix.dep_version }}"

      - name: Install build dependencies (zypper)
        if: ${{ matrix.pkg_mgr == 'zypper' }}
        run: |
          bash ci/deps/install-zypper-packages.sh \
            --family "${{ matrix.dep_family }}" \
            --os "${{ matrix.dep_os }}" \
            --version "${{ matrix.dep_version }}"

      - name: Install build dependencies (apk)
        if: ${{ matrix.pkg_mgr == 'apk' }}
        run: |
          bash ci/deps/install-apk-packages.sh \
            --family "${{ matrix.dep_family }}" \
            --os "${{ matrix.dep_os }}" \
            --version "${{ matrix.dep_version }}"

      - name: Install build dependencies (pacman)
        if: ${{ matrix.pkg_mgr == 'pacman' }}
        run: |
          bash ci/deps/install-pacman-packages.sh \
            --family "${{ matrix.dep_family }}" \
            --os "${{ matrix.dep_os }}" \
            --version "${{ matrix.dep_version }}"

      - name: Configure (legacy)
        shell: bash
        run: |
          set -x
          set -o pipefail
          ${CMAKE_BIN:-cmake} -S . -B build-cmake \
            -G Ninja \
            -DUSE_GNUINSTALLDIRS=OFF \
            -DCMAKE_INSTALL_PREFIX=/ \
            -DLEGACY_APPLY_OWNERSHIP=OFF \
            -DLEGACY_DESTDIR=/tmp/cmake-ref-root \
            -DXYMON_VARIANT=all 2>&1 | tee /tmp/cmake.configure.log

      - name: Trace CMake configure (debug)
        if: ${{ matrix.name == 'debian-bookworm' }}
        shell: bash
        run: |
          set -o pipefail
          ${CMAKE_BIN:-cmake} -S . -B build-cmake-trace \
            -G Ninja \
            -DUSE_GNUINSTALLDIRS=OFF \
            -DCMAKE_INSTALL_PREFIX=/ \
            -DLEGACY_APPLY_OWNERSHIP=OFF \
            -DLEGACY_DESTDIR=/tmp/cmake-ref-root \
            -DXYMON_VARIANT=all \
            --trace-expand \
            --trace-format=json-v1 \
            --trace-redirect=/tmp/cmake.trace.json 2>&1 | tee /tmp/cmake.trace.log

      - name: Build
        run: |
          ${CMAKE_BIN:-cmake} --build build-cmake -j2

      - name: Capture CMake configure logs
        if: always()
        run: |
          if [ -f /tmp/cmake.configure.log ]; then
            echo "=== cmake.configure.log (cmake -E search) ==="
            grep -n "cmake -E" /tmp/cmake.configure.log || true
          fi
          if [ -f /tmp/cmake.trace.json ]; then
            echo "=== cmake.trace.json (cmake -E search) ==="
            rg -n --fixed-strings -- '"cmake","-E"' /tmp/cmake.trace.json || true
          fi
          if [ -f /tmp/cmake.trace.log ]; then
            echo "=== cmake.trace.log (cmake -E search) ==="
            rg -n --fixed-strings -- "cmake -E" /tmp/cmake.trace.log || true
          fi
          if [ -f build-cmake/CMakeFiles/CMakeError.log ]; then
            echo "=== CMakeError.log ==="
            cat build-cmake/CMakeFiles/CMakeError.log
          fi
          if [ -f build-cmake/CMakeFiles/CMakeOutput.log ]; then
            echo "=== CMakeOutput.log ==="
            cat build-cmake/CMakeFiles/CMakeOutput.log
          fi

      - name: Validate config.h parity
        run: |
          legacy_config=include/config.h
          cmake_config=$(find build-cmake -name config.h | head -n1)
          if [ -z "$cmake_config" ]; then
            echo "No CMake-generated config.h found under build-cmake"
            exit 1
          fi
          if [ ! -f "$legacy_config" ]; then
            echo "Legacy config.h not found at $legacy_config; skipping parity check."
            : > /tmp/legacy.config.extract
            : > /tmp/cmake.config.extract
            : > /tmp/config.diff
            exit 0
          fi

          grep -E '^(#define|#undef) (WORDS_|HAVE_|PATH_MAX|XYMON[A-Z_]*DIR)' "$legacy_config" \
            | sort > /tmp/legacy.config.extract
          grep -E '^(#define|#undef) (WORDS_|HAVE_|PATH_MAX|XYMON[A-Z_]*DIR)' "$cmake_config" \
            | sort > /tmp/cmake.config.extract

          diff -u /tmp/legacy.config.extract /tmp/cmake.config.extract || true
          if ! diff -u /tmp/legacy.config.extract /tmp/cmake.config.extract > /tmp/config.diff; then
            echo "config.h parity diff detected:"
            cat /tmp/config.diff
            exit 1
          fi

      - name: Install legacy targets (staging)
        shell: bash
        run: |
          set -o pipefail
          ${CMAKE_BIN:-cmake} --build build-cmake --target web_cgi_links docs
          LEGACY_DESTDIR=/tmp/cmake-ref-root \
          ${CMAKE_BIN:-cmake} --build build-cmake --target install-legacy-dirs install-legacy-files 2>&1 | tee /tmp/install-cmake-legacy.log

      - name: Validate key files + metadata (non-blocking)
        shell: bash
        run: |
          set -euo pipefail
          root=/tmp/cmake-ref-root/var/lib/xymon
          if [ ! -d "$root" ]; then
            echo "Missing $root; skipping key file validation."
            exit 0
          fi

          key_files=(
            /var/lib/xymon/server/etc/xymonserver.cfg
            /var/lib/xymon/server/etc/tasks.cfg
            /var/lib/xymon/server/etc/cgioptions.cfg
            /var/lib/xymon/server/etc/graphs.cfg
            /var/lib/xymon/server/etc/client-local.cfg
            /var/lib/xymon/server/etc/columndoc.csv
            /var/lib/xymon/server/etc/protocols.cfg
          )

          : > /tmp/legacy.keyfiles.missing
          : > /tmp/legacy.keyfiles.sha256
          for f in "${key_files[@]}"; do
            p="/tmp/cmake-ref-root${f}"
            if [ ! -f "$p" ]; then
              echo "MISSING $f" >> /tmp/legacy.keyfiles.missing
              continue
            fi
            if command -v sha256sum >/dev/null 2>&1; then
              sha256sum "$p" | sed "s|$p|$f|" >> /tmp/legacy.keyfiles.sha256
            elif command -v shasum >/dev/null 2>&1; then
              shasum -a 256 "$p" | sed "s|$p|$f|" >> /tmp/legacy.keyfiles.sha256
            fi
          done

          : > /tmp/legacy.symlinks.broken
          while IFS= read -r link; do
            if [ ! -e "$link" ]; then
              echo "${link#/tmp/cmake-ref-root}" >> /tmp/legacy.symlinks.broken
            fi
          done < <(find "$root" -type l)

          : > /tmp/legacy.keyfiles.perms
          if [ "$(uname -s)" = "Darwin" ]; then
            for f in "${key_files[@]}"; do
              p="/tmp/cmake-ref-root${f}"
              [ -e "$p" ] || continue
              mode=$(stat -f '%Lp' "$p")
              uid=$(stat -f '%u' "$p")
              gid=$(stat -f '%g' "$p")
              size=$(stat -f '%z' "$p")
              printf '%s|%s|%s|%s|%s\n' "$f" "$mode" "$uid" "$gid" "$size" >> /tmp/legacy.keyfiles.perms
            done
          else
            for f in "${key_files[@]}"; do
              p="/tmp/cmake-ref-root${f}"
              [ -e "$p" ] || continue
              stat -c '%n|%a|%u|%g|%s' "$p" | sed "s|$p|$f|" >> /tmp/legacy.keyfiles.perms
            done
          fi

          legacy_key_ref=docs/cmake-legacy-migration/refs/legacy.linux.${{ matrix.variant }}.keyfiles.sha256
          if [ -s "$legacy_key_ref" ] && [ -s /tmp/legacy.keyfiles.sha256 ]; then
            sort "$legacy_key_ref" > /tmp/legacy.keyfiles.sha256.ref
            sort /tmp/legacy.keyfiles.sha256 > /tmp/legacy.keyfiles.sha256.cmake
            diff -u /tmp/legacy.keyfiles.sha256.ref /tmp/legacy.keyfiles.sha256.cmake > /tmp/legacy.keyfiles.sha256.diff || true
            if [ -s /tmp/legacy.keyfiles.sha256.diff ]; then
              echo "Key file content diff detected (non-blocking):"
              cat /tmp/legacy.keyfiles.sha256.diff
            fi
          fi

      - name: Collect symlink targets + permissions
        shell: bash
        run: |
          set -euo pipefail
          root=/tmp/cmake-ref-root/var/lib/xymon
          : > /tmp/legacy.symlinks.list
          if [ -d "$root" ]; then
            while IFS= read -r link; do
              target=$(readlink "$link" || true)
              printf '%s|%s\n' "${link#/tmp/cmake-ref-root}" "$target" >> /tmp/legacy.symlinks.list
            done < <(find "$root" -type l)
          fi

          : > /tmp/legacy.perms.snapshot
          if [ -d "$root" ]; then
            if [ "$(uname -s)" = "Darwin" ]; then
              find "$root" -type f -o -type d \
                | while IFS= read -r p; do
                    mode=$(stat -f '%Lp' "$p")
                    uid=$(stat -f '%u' "$p")
                    gid=$(stat -f '%g' "$p")
                    size=$(stat -f '%z' "$p")
                    printf '%s|%s|%s|%s|%s\n' "${p#/tmp/cmake-ref-root}" "$mode" "$uid" "$gid" "$size" >> /tmp/legacy.perms.snapshot
                  done
            else
              find "$root" -type f -o -type d \
                | while IFS= read -r p; do
                    stat -c '%n|%a|%u|%g|%s' "$p" | sed "s|$p|${p#/tmp/cmake-ref-root}|" >> /tmp/legacy.perms.snapshot
                  done
            fi
          fi

      - name: Collect binary linkage + embedded paths
        shell: bash
        run: |
          set -euo pipefail
          root=/tmp/cmake-ref-root/var/lib/xymon
          : > /tmp/legacy.bin.links
          : > /tmp/legacy.embedded.paths
          if [ -d "$root/server/bin" ]; then
            while IFS= read -r bin; do
              echo "=== ${bin#/tmp/cmake-ref-root} ===" >> /tmp/legacy.bin.links
              case "$(uname -s)" in
                Darwin)
                  otool -L "$bin" | sed '1d' | awk '{print $1}' >> /tmp/legacy.bin.links || true
                  ;;
                OpenBSD|FreeBSD|NetBSD)
                  if command -v ldd >/dev/null 2>&1; then
                    ldd "$bin" | awk '
                      /Start[[:space:]]+End[[:space:]]+Type/ {next}
                      /:$/ {next}
                      NF && $NF ~ /^\// {print $NF}
                    ' >> /tmp/legacy.bin.links || true
                  fi
                  ;;
                *)
                  if command -v ldd >/dev/null 2>&1; then
                    ldd "$bin" \
                      | sed -E 's/ \(0x[0-9a-fA-F]+\)//g' \
                      | awk '
                          $1 == "linux-vdso.so.1" {print $1; next}
                          $1 == "not" && $2 == "a" {print; next}
                          $NF ~ /^\// {print $NF}
                        ' >> /tmp/legacy.bin.links || true
                  fi
                  ;;
              esac
              if command -v strings >/dev/null 2>&1; then
                strings "$bin" | grep -E '/var/lib/xymon' >> /tmp/legacy.embedded.paths || true
              fi
            done < <(find "$root/server/bin" -type f -perm -111)
          fi
          if [ -s /tmp/legacy.embedded.paths ]; then
            sort -u /tmp/legacy.embedded.paths -o /tmp/legacy.embedded.paths
          fi

      - name: Compare legacy snapshots (non-blocking)
        shell: bash
        run: |
          set -euo pipefail
          ref_base="docs/cmake-legacy-migration/refs/legacy.linux.server"
          : > /tmp/legacy.symlinks.diff
          : > /tmp/legacy.perms.diff
          : > /tmp/legacy.binlinks.diff
          : > /tmp/legacy.embedded.diff

          if [ -s "${ref_base}.symlinks" ] && [ -s /tmp/legacy.symlinks.list ]; then
            sort "${ref_base}.symlinks" > /tmp/legacy.symlinks.ref
            sort /tmp/legacy.symlinks.list > /tmp/legacy.symlinks.cmake
            diff -u /tmp/legacy.symlinks.ref /tmp/legacy.symlinks.cmake > /tmp/legacy.symlinks.diff || true
            if [ -s /tmp/legacy.symlinks.diff ]; then
              echo "Symlink target diff detected (non-blocking):"
              cat /tmp/legacy.symlinks.diff
            fi
          fi

          if [ -s "${ref_base}.perms" ] && [ -s /tmp/legacy.perms.snapshot ]; then
            sort "${ref_base}.perms" > /tmp/legacy.perms.ref
            sort /tmp/legacy.perms.snapshot > /tmp/legacy.perms.cmake
            diff -u /tmp/legacy.perms.ref /tmp/legacy.perms.cmake > /tmp/legacy.perms.diff || true
            if [ -s /tmp/legacy.perms.diff ]; then
              echo "Permissions diff detected (non-blocking):"
              cat /tmp/legacy.perms.diff
            fi
          fi

          if [ -s "${ref_base}.binlinks" ] && [ -s /tmp/legacy.bin.links ]; then
            diff -u "${ref_base}.binlinks" /tmp/legacy.bin.links > /tmp/legacy.binlinks.diff || true
            if [ -s /tmp/legacy.binlinks.diff ]; then
              echo "Binary linkage diff detected (non-blocking):"
              cat /tmp/legacy.binlinks.diff
            fi
          fi

          if [ -s "${ref_base}.embedded.paths" ] && [ -s /tmp/legacy.embedded.paths ]; then
            diff -u "${ref_base}.embedded.paths" /tmp/legacy.embedded.paths > /tmp/legacy.embedded.diff || true
            if [ -s /tmp/legacy.embedded.diff ]; then
              echo "Embedded path diff detected (non-blocking):"
              cat /tmp/legacy.embedded.diff
            fi
          fi
      - name: Generate lists + diff
        run: |
          legacy_ref=docs/cmake-legacy-migration/refs/legacy.linux.server.ref
          if [ ! -s "$legacy_ref" ]; then
            echo "Missing or empty $legacy_ref. Generate it from legacy Makefiles and commit it."
            exit 1
          fi
          grep -v '^[[:space:]]*#' "$legacy_ref" | grep -v '^[[:space:]]*$' \
            | sed 's|/var/lib/xymon/$|/var/lib/xymon|' | sort > /tmp/legacy.list
          if [ ! -s /tmp/legacy.list ]; then
            echo "legacy.linux.server.ref contains no paths. Regenerate it from legacy Makefiles."
            exit 1
          fi
          find /tmp/cmake-ref-root/var/lib/xymon -print \
            | sed 's|^/tmp/cmake-ref-root||' \
            | sed 's|/var/lib/xymon/$|/var/lib/xymon|' \
            | sort > /tmp/cmake.list

          cat > /tmp/allowed-extras.list <<'EOF'
          /var/lib/xymon/cgi-bin/.stamp
          /var/lib/xymon/cgi-secure/.stamp
          /var/lib/xymon/install-cmake-legacy.log
          /var/lib/xymon/server/bin/availability
          /var/lib/xymon/server/bin/contest
          /var/lib/xymon/server/bin/loadhosts
          /var/lib/xymon/server/bin/locator
          /var/lib/xymon/server/bin/md5
          /var/lib/xymon/server/bin/rmd160
          /var/lib/xymon/server/bin/sha1
          /var/lib/xymon/server/bin/stackio
          /var/lib/xymon/server/bin/tree
          /var/lib/xymon/server/bin/xymon-snmpcollect
          EOF
          sed 's/^ *//' /tmp/allowed-extras.list > /tmp/allowed-extras.list.tmp
          mv /tmp/allowed-extras.list.tmp /tmp/allowed-extras.list

          grep -v -F -x -f /tmp/allowed-extras.list /tmp/cmake.list > /tmp/cmake.filtered.list

          diff -u /tmp/legacy.list /tmp/cmake.filtered.list > /tmp/legacy-cmake.diff || true
          if [ -s /tmp/legacy-cmake.diff ]; then
            echo "Unexpected diff detected (non-blocking):"
            cat /tmp/legacy-cmake.diff
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: legacy-validate-extended-${{ matrix.name }}
          path: |
            /tmp/legacy.config.extract
            /tmp/cmake.config.extract
            /tmp/config.diff
            /tmp/legacy.list
            /tmp/cmake.list
            /tmp/cmake.filtered.list
            /tmp/allowed-extras.list
            /tmp/legacy-cmake.diff
            /tmp/legacy.keyfiles.missing
            /tmp/legacy.keyfiles.sha256
            /tmp/legacy.keyfiles.perms
            /tmp/legacy.keyfiles.sha256.diff
            /tmp/legacy.symlinks.broken
            /tmp/legacy.symlinks.list
            /tmp/legacy.perms.snapshot
            /tmp/legacy.bin.links
            /tmp/legacy.embedded.paths
            /tmp/legacy.symlinks.diff
            /tmp/legacy.perms.diff
            /tmp/legacy.binlinks.diff
            /tmp/legacy.embedded.diff
            /tmp/install-cmake-legacy.log
            /tmp/cmake.configure.log
            /tmp/cmake.trace.json
            /tmp/cmake.trace.log
