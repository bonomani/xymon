name: legacy-validate-extended

on:
  workflow_dispatch:

jobs:
  legacy-validate-extended:
    runs-on: ${{ matrix.runs_on }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-22.04
            runs_on: ubuntu-22.04
          - name: ubuntu-24.04
            runs_on: ubuntu-24.04
          - name: debian-bookworm
            runs_on: ubuntu-22.04
            container: debian:bookworm
            pkg_mgr: apt
          - name: debian-bullseye
            runs_on: ubuntu-22.04
            container: debian:bullseye
            pkg_mgr: apt
          - name: rockylinux-9
            runs_on: ubuntu-22.04
            container: rockylinux:9
            pkg_mgr: dnf
          - name: almalinux-9
            runs_on: ubuntu-22.04
            container: almalinux:9
            pkg_mgr: dnf
          - name: centos-7
            runs_on: ubuntu-22.04
            container: centos:7
            pkg_mgr: yum
            cmake_bin: cmake3
          - name: fedora-40
            runs_on: ubuntu-22.04
            container: fedora:40
            pkg_mgr: dnf
          - name: opensuse-leap-15.6
            runs_on: ubuntu-22.04
            container: opensuse/leap:15.6
            pkg_mgr: zypper
          - name: alpine-3
            runs_on: ubuntu-22.04
            container: alpine:3.19
            pkg_mgr: apk
          - name: archlinux
            runs_on: ubuntu-22.04
            container: archlinux:latest
            pkg_mgr: pacman

    name: ${{ matrix.name }}
    env:
      CMAKE_BIN: ${{ matrix.cmake_bin }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies (apt)
        if: ${{ (matrix.pkg_mgr == '' || matrix.pkg_mgr == 'apt') }}
        run: |
          pcre_pkg=libpcre3-dev

          if [ -z "${{ matrix.container }}" ]; then
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
              build-essential \
              cmake \
              ninja-build \
              git \
              findutils \
              libc-ares-dev \
              ${pcre_pkg} \
              libldap2-dev \
              librrd-dev \
              libssl-dev \
              libtirpc-dev \
              zlib1g-dev
            exit 0
          fi

          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            findutils \
            libc-ares-dev \
            ${pcre_pkg} \
            libldap2-dev \
            librrd-dev \
            libssl-dev \
            libtirpc-dev \
            zlib1g-dev

      - name: Install build dependencies (dnf)
        if: ${{ matrix.pkg_mgr == 'dnf' }}
        run: |
          dnf -y install dnf-plugins-core
          if [ "${{ matrix.name }}" = "rockylinux-8" ] || [ "${{ matrix.name }}" = "almalinux-8" ]; then
            dnf config-manager --set-enabled powertools || true
          elif [ "${{ matrix.name }}" = "rockylinux-9" ] || [ "${{ matrix.name }}" = "almalinux-9" ]; then
            dnf config-manager --set-enabled crb || true
          fi
          dnf -y install epel-release || true
          dnf clean all
          dnf -y makecache
          dnf -y install \
            gcc \
            gcc-c++ \
            make \
            cmake \
            ninja-build \
            git \
            findutils \
            c-ares-devel \
            pcre-devel \
            pcre2-devel \
            openldap-devel \
            openssl-devel \
            libtirpc-devel \
            zlib-devel
          dnf -y install rrdtool-devel libtirpc-devel

      - name: Install build dependencies (yum)
        if: ${{ matrix.pkg_mgr == 'yum' }}
        run: |
          yum -y install epel-release || true
          yum -y install \
            gcc \
            gcc-c++ \
            make \
            cmake3 \
            ninja-build \
            git \
            findutils \
            c-ares-devel \
            pcre-devel \
            openldap-devel \
            openssl-devel \
            libtirpc-devel \
            zlib-devel \
            rrdtool-devel

      - name: Install build dependencies (zypper)
        if: ${{ matrix.pkg_mgr == 'zypper' }}
        run: |
          zypper --non-interactive refresh
          zypper --non-interactive install \
            gcc \
            gcc-c++ \
            make \
            cmake \
            ninja \
            git \
            findutils \
            c-ares-devel \
            pcre-devel \
            openldap2-devel \
            libopenssl-devel \
            libtirpc-devel \
            zlib-devel \
            rrdtool-devel

      - name: Install build dependencies (apk)
        if: ${{ matrix.pkg_mgr == 'apk' }}
        run: |
          apk add --no-cache \
            bash \
            build-base \
            cmake \
            ninja \
            git \
            findutils \
            c-ares-dev \
            pcre-dev \
            openldap-dev \
            rrdtool-dev \
            openssl-dev \
            libtirpc-dev \
            zlib-dev

      - name: Install build dependencies (pacman)
        if: ${{ matrix.pkg_mgr == 'pacman' }}
        run: |
          pacman -Sy --noconfirm archlinux-keyring
          pacman -Syu --noconfirm \
            base-devel \
            cmake \
            ninja \
            git \
            findutils \
            c-ares \
            pcre \
            openldap \
            rrdtool \
            openssl \
            libtirpc \
            zlib

      - name: Configure (legacy)
        run: |
          ${CMAKE_BIN:-cmake} -S . -B build-cmake \
            -G Ninja \
            -DUSE_GNUINSTALLDIRS=OFF \
            -DCMAKE_INSTALL_PREFIX=/ \
            -DLEGACY_APPLY_OWNERSHIP=OFF \
            -DLEGACY_DESTDIR=/tmp/cmake-ref-root \
            -DXYMON_VARIANT=all

      - name: Build
        run: |
          ${CMAKE_BIN:-cmake} --build build-cmake -j2

      - name: Validate config.h parity
        run: |
          legacy_config=include/config.h
          cmake_config=$(find build-cmake -name config.h | head -n1)
          if [ -z "$cmake_config" ]; then
            echo "No CMake-generated config.h found under build-cmake"
            exit 1
          fi
          if [ ! -f "$legacy_config" ]; then
            echo "Legacy config.h not found at $legacy_config; skipping parity check."
            : > /tmp/legacy.config.extract
            : > /tmp/cmake.config.extract
            : > /tmp/config.diff
            exit 0
          fi

          grep -E '^(#define|#undef) (WORDS_|HAVE_|PATH_MAX|XYMON[A-Z_]*DIR)' "$legacy_config" \
            | sort > /tmp/legacy.config.extract
          grep -E '^(#define|#undef) (WORDS_|HAVE_|PATH_MAX|XYMON[A-Z_]*DIR)' "$cmake_config" \
            | sort > /tmp/cmake.config.extract

          diff -u /tmp/legacy.config.extract /tmp/cmake.config.extract || true
          if ! diff -u /tmp/legacy.config.extract /tmp/cmake.config.extract > /tmp/config.diff; then
            echo "config.h parity diff detected:"
            cat /tmp/config.diff
            exit 1
          fi

      - name: Install legacy targets (staging)
        shell: bash
        run: |
          set -o pipefail
          ${CMAKE_BIN:-cmake} --build build-cmake --target web_cgi_links docs
          LEGACY_DESTDIR=/tmp/cmake-ref-root \
          ${CMAKE_BIN:-cmake} --build build-cmake --target install-legacy-dirs install-legacy-files 2>&1 | tee /tmp/install-cmake-legacy.log

      - name: Generate lists + diff
        run: |
          legacy_ref=docs/cmake-legacy-migration/legacy.ref
          if [ ! -s "$legacy_ref" ]; then
            echo "Missing or empty $legacy_ref. Generate it from legacy Makefiles and commit it."
            exit 1
          fi
          grep -v '^[[:space:]]*#' "$legacy_ref" | grep -v '^[[:space:]]*$' \
            | sed 's|/var/lib/xymon/$|/var/lib/xymon|' | sort > /tmp/legacy.list
          if [ ! -s /tmp/legacy.list ]; then
            echo "legacy.ref contains no paths. Regenerate it from legacy Makefiles."
            exit 1
          fi
          find /tmp/cmake-ref-root/var/lib/xymon -print \
            | sed 's|^/tmp/cmake-ref-root||' \
            | sed 's|/var/lib/xymon/$|/var/lib/xymon|' \
            | sort > /tmp/cmake.list

          cat > /tmp/allowed-extras.list <<'EOF'
          /var/lib/xymon/cgi-bin/.stamp
          /var/lib/xymon/cgi-secure/.stamp
          /var/lib/xymon/install-cmake-legacy.log
          /var/lib/xymon/server/bin/availability
          /var/lib/xymon/server/bin/contest
          /var/lib/xymon/server/bin/loadhosts
          /var/lib/xymon/server/bin/locator
          /var/lib/xymon/server/bin/md5
          /var/lib/xymon/server/bin/rmd160
          /var/lib/xymon/server/bin/sha1
          /var/lib/xymon/server/bin/stackio
          /var/lib/xymon/server/bin/tree
          /var/lib/xymon/server/bin/xymon-snmpcollect
          EOF
          sed 's/^ *//' /tmp/allowed-extras.list > /tmp/allowed-extras.list.tmp
          mv /tmp/allowed-extras.list.tmp /tmp/allowed-extras.list

          grep -v -F -x -f /tmp/allowed-extras.list /tmp/cmake.list > /tmp/cmake.filtered.list

          diff -u /tmp/legacy.list /tmp/cmake.filtered.list > /tmp/legacy-cmake.diff || true
          if [ -s /tmp/legacy-cmake.diff ]; then
            echo "Unexpected diff detected (non-blocking):"
            cat /tmp/legacy-cmake.diff
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: legacy-validate-extended-${{ matrix.name }}
          path: |
            /tmp/legacy.config.extract
            /tmp/cmake.config.extract
            /tmp/config.diff
            /tmp/legacy.list
            /tmp/cmake.list
            /tmp/cmake.filtered.list
            /tmp/allowed-extras.list
            /tmp/legacy-cmake.diff
            /tmp/install-cmake-legacy.log
